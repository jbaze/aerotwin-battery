<div class="house-visualization-container">
  <!-- Header with optimization indicator -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h3 class="text-lg font-semibold text-white mb-1 flex items-center">
        House & Battery System
        <span *ngIf="isOptimized" class="ml-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">
          ‚ú® OPTIMIZED
        </span>
      </h3>
      <p [class]="'text-sm ' + (isOptimized ? 'text-green-400' : 'text-gray-400')">
        {{ isOptimized ? 'AeroTwin Intelligence Active - Smart energy management' : 'Real-time energy flow visualization' }}
      </p>
    </div>

    <!-- Live Status & Efficiency Rating -->
    <div class="flex items-center space-x-4">
      <div class="text-center">
        <div [class]="'text-2xl font-bold ' + getEfficiencyColor()">{{ getEnergyEfficiencyRating() }}</div>
        <div class="text-xs text-gray-400">Efficiency</div>
      </div>
      <div class="flex items-center space-x-2 text-xs">
        <div [class]="'w-2 h-2 rounded-full ' + (isOptimized ? 'bg-green-400 animate-pulse' : 'bg-blue-400 animate-pulse')"></div>
        <span class="text-gray-400">{{ isOptimized ? 'Optimized' : 'Live' }}</span>
      </div>
    </div>
  </div>

  <!-- Main House Visualization with optimization effects -->
  <div [class]="'bg-gray-800 border border-gray-700 rounded-xl p-6 mb-6 transition-all duration-1000 ' + getHouseGlowClass()">

    <!-- Optimization progress overlay -->
    <div *ngIf="isTransitioning" class="absolute inset-0 bg-gradient-to-r from-transparent via-green-500/20 to-transparent animate-pulse rounded-xl pointer-events-none"></div>

    <!-- Optimization progress bar -->
    <div *ngIf="isTransitioning" class="mb-4 bg-gray-700 rounded-full h-2 overflow-hidden">
      <div class="bg-gradient-to-r from-green-400 to-green-500 h-full transition-all duration-100 ease-out"
           [style.width.%]="optimizationProgress">
      </div>
      <div class="text-center mt-2 text-green-400 text-sm font-medium">
        Applying AeroTwin Intelligence... {{ optimizationProgress }}%
      </div>
    </div>

    <div class="relative">
      <!-- Enhanced SVG House Illustration -->
      <div class="house-svg-container mx-auto" style="max-width: 500px;">
        <svg viewBox="0 0 500 400" class="w-full h-auto">
          <!-- House Structure with optimization glow -->
          <!-- Roof with solar panels -->
          <defs>
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>

            <filter id="optimizedGlow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <!-- House Roof -->
          <polygon points="50,150 250,50 450,150 400,150 250,80 100,150"
                   [attr.fill]="isOptimized ? '#1F2937' : '#374151'"
                   [attr.stroke]="isOptimized ? '#10B981' : '#6B7280'"
                   stroke-width="2"
                   [attr.filter]="isOptimized ? 'url(#optimizedGlow)' : ''"/>

          <!-- Main House Body -->
          <rect x="100" y="150" width="300" height="200"
                [attr.fill]="isOptimized ? '#0F172A' : '#1F2937'"
                [attr.stroke]="isOptimized ? '#10B981' : '#6B7280'"
                stroke-width="2"
                [attr.filter]="isOptimized ? 'url(#optimizedGlow)' : ''"/>

          <!-- Door -->
          <rect x="220" y="250" width="60" height="100"
                [attr.fill]="isOptimized ? '#1E40AF' : '#4B5563'"
                [attr.stroke]="isOptimized ? '#3B82F6' : '#6B7280'"
                stroke-width="1"/>

          <!-- Windows with smart home indicators -->
          <rect x="130" y="180" width="40" height="40"
                [attr.fill]="isOptimized ? '#FEF3C7' : '#FEF3C7'"
                [attr.stroke]="isOptimized ? '#F59E0B' : '#F59E0B'"
                stroke-width="1"
                [attr.opacity]="isOptimized ? '1' : '0.7'"
                [attr.filter]="isOptimized ? 'url(#glow)' : ''"/>
          <rect x="330" y="180" width="40" height="40"
                [attr.fill]="isOptimized ? '#FEF3C7' : '#FEF3C7'"
                [attr.stroke]="isOptimized ? '#F59E0B' : '#F59E0B'"
                stroke-width="1"
                [attr.opacity]="isOptimized ? '1' : '0.7'"
                [attr.filter]="isOptimized ? 'url(#glow)' : ''"/>

          <!-- Enhanced Solar Panels with optimization effects -->
          <rect x="200" y="90" width="100" height="40"
                [attr.fill]="isOptimized ? '#1E3A8A' : '#1E40AF'"
                [attr.stroke]="isOptimized ? '#60A5FA' : '#3B82F6'"
                [attr.stroke-width]="isOptimized ? '3' : '2'"
                rx="3"
                [attr.filter]="isOptimized ? 'url(#optimizedGlow)' : ''"/>
          <text x="250" y="108" text-anchor="middle"
                [attr.fill]="isOptimized ? '#93C5FD' : '#60A5FA'"
                font-size="10" font-weight="bold">
            SOLAR {{ isOptimized ? 'PRO' : '' }}
          </text>

          <!-- Enhanced Battery with optimization status -->
          <rect x="380" y="280" width="50" height="60"
                [attr.fill]="isOptimized ? '#064E3B' : '#065F46'"
                [attr.stroke]="isOptimized ? '#34D399' : '#10B981'"
                [attr.stroke-width]="isOptimized ? '3' : '2'"
                rx="5"
                [attr.filter]="isOptimized ? 'url(#optimizedGlow)' : ''"/>
          <text x="405" y="305" text-anchor="middle"
                [attr.fill]="isOptimized ? '#6EE7B7' : '#34D399'"
                font-size="8" font-weight="bold">
            {{ isOptimized ? 'SMART' : 'BATTERY' }}
          </text>
          <text x="405" y="318" text-anchor="middle"
                [attr.fill]="isOptimized ? '#6EE7B7' : '#34D399'"
                font-size="8">
            {{ houseData.batteryLevel }}%
          </text>

          <!-- Enhanced Grid Connection -->
          <circle cx="50" cy="250" r="15"
                  [attr.fill]="isOptimized ? '#7C2D12' : '#7C2D12'"
                  [attr.stroke]="getGridStatusColor().replace('text-', '#')"
                  [attr.stroke-width]="isOptimized ? '3' : '2'"
                  [attr.filter]="isOptimized ? 'url(#glow)' : ''"/>
          <text x="50" y="255" text-anchor="middle"
                [attr.fill]="getGridStatusColor().replace('text-', '#')"
                font-size="8" font-weight="bold">
            GRID
          </text>

          <!-- Enhanced Energy Flow Lines with optimization effects -->
          <!-- Solar to Home Flow -->
          <g *ngIf="houseData.solarProduction > 0">
            <line x1="250" y1="130" x2="250" y2="180"
                  [attr.stroke]="isOptimized ? '#FCD34D' : '#FBBF24'"
                  [attr.stroke-width]="isOptimized ? '4' : '3'"
                  opacity="0.8"
                  [attr.filter]="isOptimized ? 'url(#glow)' : ''">
              <animate attributeName="stroke-dasharray"
                       [attr.values]="isOptimized ? '0,15;15,0' : '0,10;10,0'"
                       [attr.dur]="isOptimized ? '1.5s' : '2s'"
                       repeatCount="indefinite"/>
            </line>
            <text x="255" y="155"
                  [attr.fill]="isOptimized ? '#FCD34D' : '#FBBF24'"
                  font-size="10" font-weight="bold">
              {{ houseData.solarProduction }}kW
            </text>
          </g>

          <!-- Enhanced Battery Flow -->
          <g *ngIf="houseData.batteryStatus !== 'idle'">
            <line x1="380" y1="310" x2="320" y2="250"
                  [attr.stroke]="getBatteryStatusColor().replace('text-', '#')"
                  [attr.stroke-width]="isOptimized ? '4' : '3'"
                  opacity="0.8"
                  [attr.filter]="isOptimized ? 'url(#glow)' : ''">
              <animate attributeName="stroke-dasharray"
                       [attr.values]="isOptimized ? '0,12;12,0' : '0,8;8,0'"
                       [attr.dur]="isOptimized ? '1s' : '1.5s'"
                       repeatCount="indefinite"/>
            </line>
            <text x="350" y="270"
                  [attr.fill]="getBatteryStatusColor().replace('text-', '#')"
                  font-size="9" font-weight="bold">
              {{ houseData.batteryStatus === 'charging' ? 'CHARGE' : 'POWER' }}
            </text>
          </g>

          <!-- Enhanced Grid Flow -->
          <g *ngIf="houseData.gridConnection !== 'idle'">
            <line x1="65" y1="250" x2="150" y2="250"
                  [attr.stroke]="getGridStatusColor().replace('text-', '#')"
                  [attr.stroke-width]="isOptimized ? '4' : '3'"
                  opacity="0.8"
                  [attr.filter]="isOptimized ? 'url(#glow)' : ''">
              <animate attributeName="stroke-dasharray"
                       [attr.values]="isOptimized ? '0,18;18,0' : '0,12;12,0'"
                       [attr.dur]="isOptimized ? '2s' : '2.5s'"
                       repeatCount="indefinite"/>
            </line>
            <text x="108" y="240"
                  [attr.fill]="getGridStatusColor().replace('text-', '#')"
                  font-size="9" font-weight="bold">
              {{ houseData.gridConnection === 'importing' ? 'IMPORT' : 'EXPORT' }}
            </text>
          </g>

          <!-- Optimization aura effect -->
          <g *ngIf="isOptimized">
            <circle cx="250" cy="200" r="180"
                    fill="none"
                    stroke="#10B981"
                    stroke-width="2"
                    opacity="0.3"
                    stroke-dasharray="10,10">
              <animateTransform attributeName="transform"
                              type="rotate"
                              values="0 250 200;360 250 200"
                              dur="20s"
                              repeatCount="indefinite"/>
            </circle>
          </g>
        </svg>
      </div>

      <!-- Enhanced Energy Flow Indicators -->
      <div [class]="'absolute top-4 right-4 border border-gray-600 rounded-lg p-3 transition-all duration-500 ' +
                    (isOptimized ? 'bg-green-900 border-green-600' : 'bg-gray-900')">
        <h4 [class]="'text-xs font-medium mb-2 ' + (isOptimized ? 'text-green-300' : 'text-gray-300')">
          {{ isOptimized ? 'Optimized Energy Flows' : 'Energy Flows' }}
        </h4>
        <div class="space-y-1 text-xs">
          <div class="flex items-center space-x-2">
            <div [class]="'w-2 h-2 rounded-full ' + (isOptimized ? 'bg-yellow-300' : 'bg-yellow-400')"></div>
            <span [class]="isOptimized ? 'text-green-200' : 'text-gray-400'">Solar ‚Üí Home</span>
            <span *ngIf="isOptimized" class="text-green-400 font-bold">+15%</span>
          </div>
          <div class="flex items-center space-x-2">
            <div [class]="'w-2 h-2 rounded-full ' +
                         (houseData.batteryStatus === 'charging' ?
                          (isOptimized ? 'bg-green-300' : 'bg-green-400') :
                          (isOptimized ? 'bg-blue-300' : 'bg-orange-400'))"></div>
            <span [class]="isOptimized ? 'text-green-200' : 'text-gray-400'">
              Battery {{ houseData.batteryStatus === 'charging' ? '‚Üê Solar' : '‚Üí Home' }}
            </span>
            <span *ngIf="isOptimized" class="text-green-400 font-bold">
              {{ houseData.gridConnection === 'importing' ? '-43%' : '+20%' }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Battery Details Panel -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Enhanced Battery Status -->
    <div [class]="'border border-gray-700 rounded-xl p-6 transition-all duration-500 ' +
                  (isOptimized ? 'bg-gradient-to-br from-gray-800 to-green-900 border-green-600' : 'bg-gray-800')">
      <h4 [class]="'text-lg font-medium mb-4 flex items-center ' + (isOptimized ? 'text-green-300' : 'text-white')">
        <svg [class]="'w-5 h-5 mr-2 ' + getBatteryStatusColor() + (isOptimized ? ' animate-pulse' : '')"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="getBatteryStatusIcon()"></path>
        </svg>
        {{ isOptimized ? 'Smart Battery Status' : 'Battery Status' }}
        <span *ngIf="isOptimized" class="ml-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">
          AI MANAGED
        </span>
      </h4>

      <div class="space-y-4">
        <!-- Enhanced Battery Level -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <span [class]="'text-sm ' + (isOptimized ? 'text-green-300' : 'text-gray-300')">Charge Level</span>
            <span [class]="'text-lg font-bold ' + (isOptimized ? 'text-green-400' : 'text-white')">
              {{ houseData.batteryLevel }}%
            </span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-3">
            <div [class]="'h-3 rounded-full transition-all duration-1000 ease-out ' +
                         (isOptimized ? 'bg-gradient-to-r from-green-400 to-green-500 shadow-lg shadow-green-500/30' :
                                       'bg-gradient-to-r from-green-500 to-green-400')"
                 [style.width.%]="houseData.batteryLevel">
            </div>
          </div>
          <!-- Optimization targets -->
          <div *ngIf="isOptimized" class="mt-2 text-xs text-green-400">
            Target: {{ houseData.batteryLevel < 85 ? 'Charging to 90% during low-cost hours' : 'Optimal level maintained' }}
          </div>
        </div>

        <!-- Enhanced Battery Stats -->
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span [class]="'block ' + (isOptimized ? 'text-green-400' : 'text-gray-400')">Status</span>
            <p [class]="'font-medium capitalize ' + getBatteryStatusColor()">
              {{ isOptimized ? (houseData.batteryStatus + ' (Smart)') : houseData.batteryStatus }}
            </p>
          </div>
          <div>
            <span [class]="'block ' + (isOptimized ? 'text-green-400' : 'text-gray-400')">Capacity</span>
            <p [class]="'font-medium ' + (isOptimized ? 'text-green-300' : 'text-white')">
              {{ batteryInfo.capacity }} kWh
            </p>
          </div>
          <div>
            <span [class]="'block ' + (isOptimized ? 'text-green-400' : 'text-gray-400')">Temperature</span>
            <p [class]="'font-medium ' + (isOptimized ? 'text-green-300' : 'text-white')">
              {{ batteryInfo.temperature }}¬∞C
              <span *ngIf="isOptimized && batteryInfo.temperature < 23" class="text-green-400 text-xs ml-1">‚Üì Cooler</span>
            </p>
          </div>
          <div>
            <span [class]="'block ' + (isOptimized ? 'text-green-400' : 'text-gray-400')">Health</span>
            <p [class]="'font-medium ' + (isOptimized ? 'text-green-300' : 'text-green-400')">
              {{ batteryInfo.health }}%
              <span *ngIf="isOptimized && batteryInfo.health > 96" class="text-green-400 text-xs ml-1">‚Üë Better</span>
            </p>
          </div>
        </div>

        <!-- Optimization insights -->
        <div *ngIf="isOptimized" class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-3 mt-4">
          <h5 class="text-green-300 font-semibold text-sm mb-2">ü§ñ AI Optimization Active</h5>
          <div class="text-xs text-green-200 space-y-1">
            <div>‚Ä¢ Smart charging during 2am-6am (cheap rates)</div>
            <div>‚Ä¢ Peak avoidance 6pm-9pm (expensive rates)</div>
            <div>‚Ä¢ Predictive load balancing enabled</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced System Overview -->
    <div [class]="'border border-gray-700 rounded-xl p-6 transition-all duration-500 ' +
                  (isOptimized ? 'bg-gradient-to-br from-gray-800 to-blue-900 border-blue-600' : 'bg-gray-800')">
      <h4 [class]="'text-lg font-medium mb-4 flex items-center ' + (isOptimized ? 'text-blue-300' : 'text-white')">
        <svg [class]="'w-5 h-5 mr-2 ' + (isOptimized ? 'text-blue-400' : 'text-blue-400')"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        {{ isOptimized ? 'Optimized System Data' : 'Live System Data' }}
        <span *ngIf="isOptimized" class="ml-2 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">
          ENHANCED
        </span>
      </h4>

      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <span [class]="'text-sm ' + (isOptimized ? 'text-blue-300' : 'text-gray-300')">Solar Production</span>
          <div class="text-right">
            <span [class]="'text-lg font-bold ' + (isOptimized ? 'text-yellow-300' : 'text-yellow-400')">
              {{ houseData.solarProduction }} kW
            </span>
            <span *ngIf="isOptimized" class="block text-xs text-green-400">+15% efficiency</span>
          </div>
        </div>

        <div class="flex justify-between items-center">
          <span [class]="'text-sm ' + (isOptimized ? 'text-blue-300' : 'text-gray-300')">Home Consumption</span>
          <div class="text-right">
            <span [class]="'text-lg font-bold ' + (isOptimized ? 'text-blue-300' : 'text-blue-400')">
              {{ houseData.homeConsumption }} kW
            </span>
            <span *ngIf="isOptimized" class="block text-xs text-green-400">-12% waste</span>
          </div>
        </div>

        <div class="flex justify-between items-center">
          <span [class]="'text-sm ' + (isOptimized ? 'text-blue-300' : 'text-gray-300')">Grid Status</span>
          <div class="text-right">
            <span [class]="'text-lg font-bold capitalize ' + getGridStatusColor()">
              {{ houseData.gridConnection }}
            </span>
            <span *ngIf="isOptimized" class="block text-xs text-green-400">
              {{ houseData.gridConnection === 'importing' ? '-43% import' : '+20% export' }}
            </span>
          </div>
        </div>

        <!-- Enhanced Energy Flow Summary -->
        <div [class]="'pt-3 border-t ' + (isOptimized ? 'border-blue-600' : 'border-gray-600')">
          <div [class]="'text-xs mb-2 ' + (isOptimized ? 'text-blue-300' : 'text-gray-400')">
            {{ isOptimized ? 'Optimized Energy Flows:' : 'Active Energy Flows:' }}
          </div>
          <div class="flex flex-wrap gap-2">
            <span *ngFor="let flow of houseData.energyFlows; trackBy: trackByFlow"
                  [class]="'text-gray-300 px-2 py-1 rounded text-xs transition-all duration-300 ' +
                           (isOptimized ? 'bg-green-700 border border-green-600' : 'bg-gray-700')">
              {{ flow.from }} ‚Üí {{ flow.to }}
              <span *ngIf="isOptimized" class="text-green-300 ml-1 font-bold">
                {{ flow.amount.toFixed(1) }}kW
              </span>
            </span>
          </div>
        </div>

        <!-- Real-time efficiency metrics -->
        <div *ngIf="isOptimized" class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-3 mt-4">
          <h5 class="text-blue-300 font-semibold text-sm mb-2">‚ö° Performance Boost</h5>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="text-center">
              <div class="text-green-400 font-bold text-lg">20.8%</div>
              <div class="text-blue-200">More Efficient</div>
            </div>
            <div class="text-center">
              <div class="text-green-400 font-bold text-lg">¬£78</div>
              <div class="text-blue-200">Saved/Month</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Optimization comparison panel -->
  <div *ngIf="isOptimized" class="mt-6 bg-gradient-to-r from-green-900 via-teal-900 to-blue-900 border border-green-600 rounded-xl p-6 animate-fade-in">
    <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
      <svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
      </svg>
      AeroTwin Intelligence Impact Summary
    </h4>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-gray-800 rounded-lg p-4 text-center border border-green-600">
        <div class="text-2xl font-bold text-green-400 mb-1">Smart Timing</div>
        <div class="text-sm text-green-300">Charging optimized for low-cost hours</div>
        <div class="text-xs text-gray-400 mt-1">2am-6am window active</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4 text-center border border-blue-600">
        <div class="text-2xl font-bold text-blue-400 mb-1">Peak Avoidance</div>
        <div class="text-sm text-blue-300">Reduced grid dependency during expensive hours</div>
        <div class="text-xs text-gray-400 mt-1">6pm-9pm protection active</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4 text-center border border-yellow-600">
        <div class="text-2xl font-bold text-yellow-400 mb-1">Smart Export</div>
        <div class="text-sm text-yellow-300">Maximized revenue from excess solar</div>
        <div class="text-xs text-gray-400 mt-1">+20% export efficiency</div>
      </div>
    </div>
  </div>
</div>
